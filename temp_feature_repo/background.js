import{translate,browser}from"./js/cllama.js";import{sendToContentScript}from"./js/util.js";function sendTranslateMsg(e){sendToContentScript({action:"translate",msg:e})}browser.contextMenus.create({id:"translate",title:browser.i18n.getMessage("translate"),contexts:["selection"]});let stopFlag=!1,isFirefox=(browser.contextMenus.onClicked.addListener((e,t)=>{"translate"===e.menuItemId&&(e=e.selectionText,sendTranslateMsg(browser.i18n.getMessage("translateWaitMessage")),translate(e,sendTranslateMsg,{stop:function(){return stopFlag}}).catch(e=>{console.error("translate error:",e),sendTranslateMsg(browser.i18n.getMessage("cllamaError"))}))}),0<=navigator.userAgent.indexOf("Firefox"));function handleMessage(e,s,t){if("openHtmlInNewTab"===e.action){let{htmlString:r,title:s}=e.data;var a;isFirefox?browser.tabs.create({url:browser.runtime.getURL("viewer/viewer.html")},e=>{var t;browser.runtime.lastError?console.error("Failed to create viewer tab. Error: "+browser.runtime.lastError.message):((t={})["viewer_data_"+e.id]={htmlString:r,title:s},browser.storage.local.set(t))}):(a=`<!DOCTYPE html><html><head><title>${s}</title></head><body>${r}</body></html>`,a="data:text/html;charset=utf-8,"+encodeURIComponent(a),browser.tabs.create({url:a}))}else if("viewerReady"===e.action){if(isFirefox){let t=s.tab.id,r="viewer_data_"+t;browser.storage.local.get(r,e=>{e[r]&&e[r].htmlString&&(browser.tabs.sendMessage(t,{action:"displayHtml",data:e[r]}),browser.storage.local.remove(r))})}}else"close_translate"==e&&(stopFlag=!0,setTimeout(function(){stopFlag=!1},200)),"string"==typeof e?t({received:!0,originalMessage:e}):"userAction"===e.type&&(console.log(`User action: ${e.action} on `+e.elementId),t({status:"processed",action:e.action}));return!0}async function handleInstalled(e){"install"!==e.reason&&"update"===e.reason&&"2.1.2"==e.previousVersion&&await browser.storage.local.get(null,function(e){for(var t of Object.keys(e)){var r;t.startsWith("chatHistory_")&&(r=e[t])instanceof Array&&browser.storage.local.set({[t]:{currentId:0,history:[{id:0,name:"00",records:r}]}})}})}browser.runtime.onMessage.addListener(handleMessage),browser.runtime.onInstalled.addListener(handleInstalled);