import{defaultSettings,i18n,DB_KEY}from"../js/cllama.js";import{getService}from"../js/client/client.mjs";import{balert}from"../js/dialog.mjs";import{exportFile}from"../js/util.js";let dsList=[],mflag=!0,ds={},browser="undefined"!=typeof chrome?chrome:browser;async function initPage(){await browser.storage.local.get(DB_KEY.base,setFormValue),await browser.storage.local.get(DB_KEY.dsList,e=>{dsList=e[DB_KEY.dsList]||[]})}function setFormValue(e){(ds=e[DB_KEY.base]||defaultSettings).service&&ds.apiUrl&&setModelList(ds.service,ds.apiUrl,ds.apiKey);for(var t of Object.keys(ds)){var s;"service"===t?(s=document.getElementById(ds[t]))&&(s.checked=!0):(s=document.getElementById(t))&&(s.value=ds[t])}}async function setModelList(e,t,a){try{let s=document.getElementById("modelName");var r=await getService(e,t,a).getModels();s.length=0,r.forEach(e=>{var t=new Option(e,e);s.add(t),ds?.modelName===e&&(t.selected=!0)}),mflag=!1}catch(e){console.log(browser.i18n.getMessage("getModuleListFailMessage")+"\n"+e)}}async function saveSettings(){let t=document.querySelector('input[name="service"]:checked').value;var e=document.getElementById("apiUrl").value.trim(),s=document.getElementById("apiKey").value.trim(),a=document.getElementById("modelName").value.trim(),r=document.getElementById("tranPrompt").value.trim();if(!e||!a||!r)return balert(browser.i18n.getMessage("requiredError")),!1;e={service:t,apiUrl:e,apiKey:s,modelName:a,tranPrompt:r},s=dsList.find(e=>e.service===t);s?Object.assign(s,e):dsList.push(e),await browser.storage.local.set({[DB_KEY.base]:e}),await browser.storage.local.set({[DB_KEY.dsList]:dsList}),alert(browser.i18n.getMessage("saveSuccessMessage"))}async function exportData(){let t=Array.from(document.querySelectorAll('input[name="exportOptions"]:checked')).map(e=>e.value);0===t.length?balert(browser.i18n.getMessage("exportOptionEmptyError")):await browser.storage.local.get(null,function(s){let a={};t.forEach(e=>{if("chatData"==e)for(var t of Object.keys(s))t.startsWith("chatHistory_")&&(a[t]=s[t]);else"base"==e?(a[e]=s[e],a.dsList=s.dsList):a[e]=s[e]});var e=JSON.stringify(a,null,2);exportFile(e,"json","db.json")})}function bindEventListeners(){document.querySelectorAll(".mflag").forEach(e=>{e.addEventListener("change",()=>mflag=!0)}),document.getElementById("modelName").addEventListener("focus",async()=>{mflag&&await setModelList(document.querySelector('input[name="service"]:checked').value,document.getElementById("apiUrl").value,document.getElementById("apiKey").value)}),document.getElementById("b_save").addEventListener("click",saveSettings),document.querySelectorAll(".llmtype").forEach(s=>{s.addEventListener("click",()=>{mflag=!0;let t=s.getAttribute("for");var e=dsList.find(e=>e.service===t);e?setFormValue({[DB_KEY.base]:e}):(document.getElementById("apiUrl").value=s.getAttribute("data-url"),document.getElementById("apiKey").value="",document.getElementById("modelName").value="")})}),document.getElementById("a_export").addEventListener("click",exportData),document.getElementById("b_upload").addEventListener("click",function(e){let r=["base","dsList","actionList","chatTpaList","insightList","urls"];var t,s=document.getElementById("jsonFile").files[0];s&&s.name.endsWith(".json")&&((t=new FileReader).onload=async e=>{try{var t,s=JSON.parse(e.target.result),a={};for(t of Object.keys(s))(r.includes(t)||t.startsWith("chatHistory_"))&&(a[t]=s[t]);0===Object.keys(a).length?balert(browser.i18n.getMessage("importFailMsg1")):(await browser.storage.local.set(a),balert(browser.i18n.getMessage("importSuccessMessage")),await initPage())}catch(e){balert(browser.i18n.getMessage("importFailMessage")+"\n"+e)}},t.readAsText(s))}),document.getElementById("jsonFile").addEventListener("change",function(e){var t=document.getElementById("fileName");0<this.files.length?t.textContent="已选择文件: "+this.files[0].name:t.textContent=""})}document.addEventListener("DOMContentLoaded",async()=>{await initPage(),bindEventListeners(),i18n()}),document.getElementById("togglePassword").addEventListener("click",function(){var e=document.getElementById("apiKey"),t="password"===e.getAttribute("type")?"text":"password";e.setAttribute("type",t),"password"==t?document.getElementById("eyeOrEyeslash").setAttribute("href","#eye"):document.getElementById("eyeOrEyeslash").setAttribute("href","#eye-slash")});