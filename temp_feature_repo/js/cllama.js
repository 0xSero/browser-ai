import{TextProcessor}from"./text-processor.mjs";import{ThemeManager}from"./theme.mjs";import{marked}from"./marked.mjs";import{copyToClipboard,thinkCollapseExpanded}from"./marked/copy.mjs";import{balert}from"./dialog.mjs";import{getServiceInstance}from"./client/client.mjs";import{cloneOllamaOptions,removeThinkTags,replaceElementContent,replaceThinkTags}from"./util.js";let browser="undefined"!=typeof chrome?chrome:browser,isFirefox=0<=navigator.userAgent.indexOf("Firefox"),defaultSettings={service:"Qwen",apiUrl:"https://api.suanli.cn/v1/chat/completions",apiKey:"sk-W0rpStc95T7JVYVwDYc29IyirjtpPPby6SozFMQr17m8KWeo",modelName:"free:QwQ-32B",maxTokens:18e3,tranPrompt:browser.i18n.getMessage("tranPrompt").replaceAll("{localLanguage}",browser.i18n.getMessage("localLanguage"))},runtimeConfig={...defaultSettings},chatClient;async function loadConfiguration(){return new Promise(t=>{browser.storage.local.get(DB_KEY.base,e=>{e=e[DB_KEY.base]||{};runtimeConfig={...defaultSettings,...e},t()})})}async function getClientService(){return chatClient||(await loadConfiguration(),chatClient=getServiceInstance(runtimeConfig)),chatClient}async function getRuntimeConfig(){return await getClientService(),runtimeConfig}function renderWithDebounce(e,t){replaceElementContent(e,marked.parse(replaceThinkTags(t))),copyToClipboard(e)}async function summarize(e,t,n,o){let r=document.getElementById(n);n=await getClientService(),e=0<e.indexOf("${doc.")?[{role:"user",content:TextProcessor.renderTemplate(e,t)}]:[{role:"system",content:e},{role:"user",content:t.title+`
`+t.content}];n.sendRequest(e,{onStream:(e,t)=>renderWithDebounce(r,t),onComplete:(e,t)=>{renderWithDebounce(r,e),"function"==typeof o?.finish&&o.finish(e)},onError:(e,t)=>"function"==typeof o?.error&&o.error(e,t)})}async function chat(r,i){let a=i.msgDiv,s=i.messages,l=await getClientService();if(!(null==r||r.length<1)){let n=[],o="ollama"==runtimeConfig.service;r.forEach(e=>{let t={role:e.role,content:removeThinkTags(e.content)};e.images&&(o?t.images=e.images.map(e=>e.split(",")[1]):(t.content=[{type:"text",text:t.content}],e.images.forEach(e=>{t.content.push({type:"image_url",image_url:{url:e}})}))),n.push(t)});var e=cloneOllamaOptions(i);return await l.sendRequest(n,{model:i?.model,options:e,onStart:()=>{"function"==typeof i?.start&&i.start()},onStream:(e,t,n)=>{i.stop()?(l.abort(n),"function"==typeof i?.finish&&i.finish(),r.pop()):(renderWithDebounce(a,t),i?.stopScroll()||(s.scrollTop=s.scrollHeight))},onComplete:(e,t)=>{renderWithDebounce(a,e),thinkCollapseExpanded(a),r.push({role:"assistant",content:e,rtime:Date.now()}),"function"==typeof i?.finish&&i.finish(r)},onError:(e,t)=>{"AbortError"!==e.name&&balert(`[${t}] Error:`+e,{title:"Error"})}})}}async function translate(e,n,o){let r=await getClientService();r.sendRequest([{role:"system",content:runtimeConfig.tranPrompt},{role:"user",content:e}],{onStream:(e,t)=>{n(t),o?.stop()&&r.abortAllSessions()},onComplete:(e,t)=>{n(removeThinkTags(full))}})}async function getModels(){return await getClientService(),chatClient.getModels()}async function abortSession(e){(await getClientService()).abort(e)}function i18n(){document.querySelectorAll(".i18n").forEach(e=>{var t=e.getAttribute("i18n")||"text",n="text"===t?e.textContent:e.getAttribute(t);n&&(n=browser.i18n.getMessage(n))&&("text"===t?e.textContent=n:e.setAttribute(t,n))})}let DB_KEY={base:"base",urls:"urls",actionList:"actionList",chatTpaList:"chatTpaList",insightList:"insightList",dsList:"dsList",apiConfig:"apiConfig",fishIconActive:"fishIconActive"};browser.extension&&browser.extension.getBackgroundPage&&(window.themeManager=new ThemeManager);export{browser,isFirefox,defaultSettings,getClientService,getRuntimeConfig,summarize,chat,translate,getModels,abortSession,i18n,DB_KEY};