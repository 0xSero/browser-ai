class ChatGPTClient{constructor(e){if(!e||!e.endpoint||!e.apiKey)throw new Error("Missing required configuration: endpoint, apiKey");e.service&&(this._service=e.service),this.endpoint=e.endpoint.replace(/\/$/,""),this.apiKey=e.apiKey,this.defaultModel=e.defaultModel,this.modelsEndpoint=this.endpoint.replace(/\/chat\/completions$/,"")+"/models",this.modelsCache=null,this.activeSessions=new Map}async getModels(e=!1){if(this._service){if("ZhiPu"==this._service)return["GLM-4-Flash","GLM-4.1V-Thinking-FlashX","GLM-4-Plus"];if("Google"==this._service)return["gemini-2.5-flash","gemini-2.5-pro"]}if(!e&&this.modelsCache)return this.modelsCache;try{var t,r=await fetch(this.modelsEndpoint,{headers:{Authorization:"Bearer "+this.apiKey,"Content-Type":"application/json"}});if(r.ok)return t=await r.json(),this.modelsCache=t.data.map(e=>e.id),this.modelsCache;throw new Error("API request failed with status "+r.status)}catch(e){throw console.error("Failed to fetch models:",e),new Error("Failed to retrieve model list")}}async sendRequest(e,t={}){var r=this._generateSessionId(),o=new AbortController,e=(this.activeSessions.set(r,o),{model:t.model||this.defaultModel,messages:e,temperature:t.temperature??1,top_p:t.top_p??.9,stream:!0});"function"==typeof t.onStart&&t.onStart(r);try{var i,s=await fetch(this.endpoint,{method:"POST",headers:{Authorization:"Bearer "+this.apiKey,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e),signal:o.signal});if(s.ok)return await this._processStreamResponse(s,r,t),r;throw i=await s.json(),new Error(i.error?.message||"Request failed with status "+s.status)}catch(e){throw this.activeSessions.delete(r),"AbortError"!==e.name&&"function"==typeof t.onError&&t.onError(e,r),e}}async _processStreamResponse(e,t,r){var o=e.body.getReader(),i=new TextDecoder;let s="",a="";try{for(;;){if(!this.activeSessions.has(t)){await o.cancel();break}var{done:n,value:c}=await o.read();if(n)break;var h,l=(a+=i.decode(c,{stream:!0})).split("\n");a=l.pop()||"";for(h of l){var d=h.trim();if(d){if("data: [DONE]"===d){a="";break}var p=d.indexOf("data: ");if(-1!==p){var f=d.slice(p+5).trim();if(f)try{var m=JSON.parse(f).choices[0]?.delta?.content||"";m&&(s+=m,"function"==typeof r.onStream)&&r.onStream(m,s,t)}catch(e){throw new Error("Error: "+e.message)}}}}}a.trim()&&console.warn("发现未处理的残留数据:",a),this.activeSessions.delete(t),"function"==typeof r.onComplete&&r.onComplete(s,t)}catch(e){if(this.activeSessions.delete(t),"AbortError"!==e.name&&"function"==typeof r.onError&&r.onError(e,t),"AbortError"!==e.name)throw e}finally{o&&await o.cancel().catch(()=>{})}}abort(e){var t=this.activeSessions.get(e);return!!t&&(t.abort(),this.activeSessions.delete(e),!0)}abortAllSessions(){for(var[e,t]of this.activeSessions)t.abort(),this.activeSessions.delete(e)}_generateSessionId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36).substring(2)}}export{ChatGPTClient};