import{Ollama}from"./ollama.mjs";let DEFAULT_MODEL="gemma3";class OllamaClient{constructor(t){if(!t||!t.endpoint)throw new Error("Endpoint is required in config");this.client=new Ollama({host:t.endpoint}),this.config={...t,defaultModel:t.defaultModel||DEFAULT_MODEL},this.activeSessions=new Map,this.cachedModels=null}async getModels(t=!1){try{var e;return!t&&this.cachedModels||(e=await this.client.list(),this.cachedModels=e.models.map(t=>t.name)),this.cachedModels}catch(t){throw console.error("Failed to fetch models:",t),new Error("Failed to get models: "+t.message)}}async sendRequest(t,e={}){if(!t||!Array.isArray(t))throw new Error("Messages must be an array");var s=e.model||this.config.defaultModel,o=this.estimateTokens(JSON.stringify(t)),r={...e.options},o=(!r.num_ctx&&1800<o&&(r.num_ctx=o),e?.options?.think??!0);let n=null;var i;let a=null;var l,c,h=[],s={model:s,messages:t,options:r,stream:!0};o||(s.think=!1);try{n=`sess_${Date.now()}_`+Math.random().toString(36).substr(2,9),"function"==typeof e.onStart&&e.onStart(n),i=new AbortController,this.activeSessions.set(n,{controller:i,request:s});for await(var m of a=await this.client.chat({signal:i.signal,...s})){if(!this.activeSessions.has(n))break;m.message?.content&&(l=m.message.content,h.push(l),"function"==typeof e.onStream)&&e.onStream(l,h.join(""),n)}return this.activeSessions.has(n)&&(c=h.join(""),"function"==typeof e.onComplete&&e.onComplete(c,n),this.activeSessions.delete(n)),n}catch(t){if("AbortError"!==t.name&&"function"==typeof e.onError&&e.onError(t,n),this.activeSessions.has(n)&&this.activeSessions.delete(n),"AbortError"!==t.name)throw t;return n}finally{a&&"function"==typeof a.abort&&a.abort(),this.activeSessions.has(n)&&this.activeSessions.delete(n)}}abort(t){if(t){var e=this.activeSessions.get(t);if(e)try{return e.controller.abort(),this.activeSessions.delete(t),!0}catch(t){console.error("Abort error:",t)}}return!1}abortAllSessions(){let t=0;for(var[e,s]of this.activeSessions)try{s.controller.abort(),this.activeSessions.delete(e),t++}catch(t){console.error(`Error aborting session ${e}:`,t)}return t}estimateTokens(t){var e,s;return t?(e=t.match(/[\u4e00-\u9fa5]/g)||[],s=t.split(/[\s\n]+/).filter(t=>t),t=t.match(/[^\p{L}\s]/gu)||[],e=1.3*e.length,s=1.3*s.length,t=.7*t.length,Math.ceil(1.1*(e+s+t))):0}}export{OllamaClient};