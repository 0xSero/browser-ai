let version="0.0.0",defaultPort="11434",defaultHost="http://127.0.0.1:"+defaultPort;var __defProp$1=Object.defineProperty,__defNormalProp$1=(e,t,s)=>t in e?__defProp$1(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,__publicField$1=(e,t,s)=>(__defNormalProp$1(e,"symbol"!=typeof t?t+"":t,s),s);class ResponseError extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,ResponseError)}}class AbortableAsyncIterator{constructor(e,t,s){__publicField$1(this,"abortController"),__publicField$1(this,"itr"),__publicField$1(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=s}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(var e of this.itr){if("error"in e)throw new Error(e.error);if(yield e,e.done||"success"===e.status)return this.doneCallback(),void 0}throw new Error("Did not receive done or success response in stream.")}}let checkOk=async t=>{if(!t.ok){let e=`Error ${t.status}: `+t.statusText;var s;if(t.headers.get("content-type")?.includes("application/json"))try{s=await t.json(),e=s.error||e}catch(e){console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response");var r=await t.text();e=r||e}catch(e){console.log("Failed to get text from error response")}throw new ResponseError(e,t.status)}};function getPlatform(){return"undefined"!=typeof window&&window.navigator?`${window.navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:"undefined"!=typeof process?process.arch+` ${process.platform} Node.js/`+process.version:""}let fetchWithHeaders=async(e,t,s={})=>{let r={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/${version} (${getPlatform()})`};s.headers||(s.headers={});var a=Object.fromEntries(Object.entries(s.headers).filter(([t])=>!Object.keys(r).some(e=>e.toLowerCase()===t.toLowerCase())));return s.headers={...r,...a},e(t,s)},get=async(e,t,s)=>{e=await fetchWithHeaders(e,t,{headers:s?.headers});return await checkOk(e),e},post=async(e,t,s,r)=>{var a=null===(a=s)||"object"!=typeof a||Array.isArray(a)?s:JSON.stringify(s),s=await fetchWithHeaders(e,t,{method:"POST",body:a,signal:r?.signal,headers:r?.headers});return await checkOk(s),s},del=async(e,t,s,r)=>{e=await fetchWithHeaders(e,t,{method:"DELETE",body:JSON.stringify(s),headers:r?.headers});return await checkOk(e),e},parseJSON=async function*(e){var t=new TextDecoder("utf-8");let s="";for(var r,a=e.getReader();;){var{done:o,value:i}=await a.read();if(o)break;var n,o=(s+=t.decode(i)).split("\n");s=o.pop()??"";for(n of o)try{yield JSON.parse(n)}catch(e){console.warn("invalid json: ",n)}}for(r of s.split("\n").filter(e=>""!==e))try{yield JSON.parse(r)}catch(e){console.warn("invalid json: ",r)}},formatHost=e=>{if(!e)return defaultHost;let t=e.includes("://");e.startsWith(":")&&(e="http://127.0.0.1"+e,t=!0),t||(e="http://"+e);e=new URL(e);let s=e.port,r=(s=s||(t?"https:"===e.protocol?"443":"80":defaultPort),e.protocol+`//${e.hostname}:`+s+e.pathname);return r=r.endsWith("/")?r.slice(0,-1):r};var __defProp=Object.defineProperty,__defNormalProp=(e,t,s)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,__publicField=(e,t,s)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,s),s);let Ollama$1=class{constructor(e){__publicField(this,"config"),__publicField(this,"fetch"),__publicField(this,"ongoingStreamedRequests",[]),this.config={host:"",headers:e?.headers},e?.proxy||(this.config.host=formatHost(e?.host??defaultHost)),this.fetch=e?.fetch??fetch}abort(){for(var e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,s){s.stream=s.stream??!1;e=this.config.host+"/api/"+e;if(s.stream){var r=new AbortController,a=await post(this.fetch,e,s,{signal:r.signal,headers:this.config.headers});if(!a.body)throw new Error("Missing body");a=parseJSON(a.body);let t=new AbortableAsyncIterator(r,a,()=>{var e=this.ongoingStreamedRequests.indexOf(t);-1<e&&this.ongoingStreamedRequests.splice(e,1)});return this.ongoingStreamedRequests.push(t),t}return(await post(this.fetch,e,s,{headers:this.config.headers})).json()}async encodeImage(e){if("string"==typeof e)return e;{var s=new Uint8Array(e);let t="";var r=s.byteLength;for(let e=0;e<r;e++)t+=String.fromCharCode(s[e]);return btoa(t)}}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(var t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{...e})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await del(this.fetch,this.config.host+"/api/delete",{name:e.model},{headers:this.config.headers}),{status:"success"}}async copy(e){return await post(this.fetch,this.config.host+"/api/copy",{...e},{headers:this.config.headers}),{status:"success"}}async list(){return(await get(this.fetch,this.config.host+"/api/tags",{headers:this.config.headers})).json()}async show(e){return(await post(this.fetch,this.config.host+"/api/show",{...e},{headers:this.config.headers})).json()}async embed(e){return(await post(this.fetch,this.config.host+"/api/embed",{...e},{headers:this.config.headers})).json()}async embeddings(e){return(await post(this.fetch,this.config.host+"/api/embeddings",{...e},{headers:this.config.headers})).json()}async ps(){return(await get(this.fetch,this.config.host+"/api/ps",{headers:this.config.headers})).json()}};export{Ollama$1 as Ollama};