import{getService}from"../js/client/client.mjs";import{chat,i18n,DB_KEY,browser,getRuntimeConfig,abortSession}from"../js/cllama.js";import{marked}from"../js/marked.mjs";import{copyToClipboard,thinkCollapseExpanded}from"../js/marked/copy.mjs";import{exportFile,findMatchingParentNode,formatTimestamp,getQueryParam,replaceElementContent,replaceThinkTags}from"../js/util.js";document.addEventListener("DOMContentLoaded",async()=>{let o={temperature:1,top_p:.9,think:!1},h=document.getElementById("messages"),l=document.getElementById("msgInput"),r=document.getElementById("chatCategory"),t=document.getElementById("sendBtn"),a=document.getElementById("cancelBtn"),s=document.getElementById("b_fish"),d=(s&&(s.title=browser.i18n.getMessage("fish_title")),getQueryParam("id")),c=!0,f=[],m=null,n=h.scrollTop,v=!1,p="",g=[],i,u=!0;async function y(){var n=l.value.trim(),i=Date.now();if(n){let r=p,a=(l.value="",w(n,"self",i),f.push({role:"user",content:n,rtime:i}),w("",r,i+1,!1).querySelector(".message-text")),t=(replaceElementContent(a,"<img src='/images/thinking.webp' style='width:52px;height:52px;' />"),[]),e=(f.forEach(e=>{"user"===e.role&&e.fileInfo&&e.fileInfo.send&&(t.unshift(e.content),e.fileInfo.send=!1)}),u?JSON.parse(JSON.stringify(f)):[JSON.parse(JSON.stringify(f[f.length-1]))]);0<t.length&&"user"===(n=e[e.length-1]).role&&(n.images=t),e=e.filter(e=>!("user"===e.role&&(e.fileInfo||e.content.startsWith("<img"))));let s=d;s&&"0"!==s&&0<g.length&&(i=g.find(e=>String(e.id)===s))&&i.prompt&&e.unshift({role:"system",content:i.prompt}),m=chat(e,{msgDiv:a,messages:h,model:r,temperature:o.temperature,top_p:o.top_p,think:o.think,start:()=>{b(!(c=!1))},finish:e=>{var t;e&&0<e.length&&"assistant"===(e=e[e.length-1]).role&&((e={...e}).rtime||(e.rtime=Date.now()),e.model=r,f.push(e),(t=findMatchingParentNode(a,".bot-message")).dataset.timestamp=e.rtime,t.querySelector(".copy-message-btn").setAttribute("data-flag","true"),t.querySelector(".delete-message-btn").setAttribute("data-flag","true")),S(!1),k(),b(!1)},stop:()=>c,stopScroll:()=>v}).catch(e=>{"AbortError"!==e.name&&(console.error("聊天错误:",e),replaceElementContent(a,""),I(browser.i18n.getMessage("cllamaError"),"system-error-message"),S(!1),k()),b(!1),m=null})}}function b(e){e?(t.setAttribute("hidden","true"),a.removeAttribute("hidden"),l.disabled=!0,c=!1):(a.setAttribute("hidden","true"),t.removeAttribute("hidden"),l.disabled=!1,c=!0,m=null)}function w(e,t,r,a,s){var n="self"==t,t=n?"":t,i=n?"user":"bot",o=n?"rightClass":"",l=formatTimestamp(r);let d=document.createElement("div"),c=(d.className=`message ${i}-message`,d.dataset.timestamp=r,n?"self-message":"markdown-body"),m=n?"pre":"div",p=e,g=(s&&s.type&&(m="div",c="",p=s.type.startsWith("image/")?`<a href="${e}" target="_blank"><img src="${e}" alt="${s.name}" style="max-width: 100%; max-height: 300px; border-radius: 5px;"></a>`:"application/pdf"===s.type?`<a href="${e}" class="file-link" download="${s.name}" data-filename="${s.name}" data-filetype="${s.type}"}">
                            <img src="../images/file-pdf.svg" class="filetype theme-icon-active"> ${s.name}
                        </a>`:s.type.startsWith("video/")?`<a href="${e}" class="file-link" download="${s.name}" data-filename="${s.name}" data-filetype="${s.type}">
                            <img src="../images/file-video.svg" class="filetype theme-icon-active"> ${s.name}
                        </a>`:s.type.startsWith("audio/")?`<a href="${e}" class="file-link" download="${s.name}" data-filename="${s.name}" data-filetype="${s.type}">
                            <img src="../images/file-audio.svg" class="filetype theme-icon-active">  ${s.name}
                        </a>`:`<a href="${e}" class="file-link" download="${s.name}" data-filename="${s.name}" data-filetype="${s.type}">
                            ${s.name}
                        </a>`),d.innerHTML=`
            <div class="message-content ${o}">
                <div class="message-header">
                    <span class="message-sender">${t}</span>
                    <span class="message-time">${l}</span>
                    ${s?`<a href="#" class="activate-message-btn" data-flag="${a}" style="margin-left: 5px;text-decoration: none;font-size: 10pt;" title="${browser.i18n.getMessage("activate")}">${s.send?"☑":"◻"}</a>`:""}
                    <img src="/images/copy.svg" class="copy-message-btn" data-flag="${a}" style="height:13px;" title="${browser.i18n.getMessage("copy")}" />
                    <img src="/images/clear.svg" class="delete-message-btn" data-flag="${a}" style="height:13px;" title="${browser.i18n.getMessage("delete")}"/>                    
                </div>
                <${m} class="message-text ${c}">${p}</${m}>
            </div>
        `,d.querySelector(".copy-message-btn")),u=(g.addEventListener("click",async r=>{if("false"!=g.getAttribute("data-flag")){r.stopPropagation();let t=parseInt(d.dataset.timestamp,10);r=f.find(e=>e.rtime===t);if(r)try{await navigator.clipboard.writeText(r.content);let e=g.title;g.src="/images/check.svg",g.title=browser.i18n.getMessage("copied"),setTimeout(()=>{g.src="/images/copy.svg",g.title=e},1500)}catch(e){alert(browser.i18n.getMessage("replicationFailed"))}}}),d.querySelector(".delete-message-btn")),y=(u.addEventListener("click",async e=>{if("false"!=u.getAttribute("data-flag")&&(e.stopPropagation(),await $(browser.i18n.getMessage("confirmDelete")))){let t=parseInt(d.dataset.timestamp,10);f=f.filter(e=>e.rtime!==t),k(),d.remove()}}),d.querySelector(".activate-message-btn"));return y&&y.addEventListener("click",async e=>{if("false"!=y.getAttribute("data-flag")){e.stopPropagation();let t=parseInt(d.dataset.timestamp,10);e=f.find(e=>e.rtime===t);e&&e.fileInfo&&(e.fileInfo.send=!e.fileInfo.send,y.textContent=e.fileInfo.send?"☑":"◻")}}),h.appendChild(d),v||(h.scrollTop=h.scrollHeight),d}function I(e,t){var r=document.createElement("div");r.className="message",r.innerHTML=`
            <div class="message-content ${t}">
                <div class="message-info">${e}</div>
            </div>
        `,h.appendChild(r),v||(h.scrollTop=h.scrollHeight)}async function E(e,r){let a=e||"0",s="chatHistory_"+a;browser.storage.local.get(s,e=>{let t=e[s];t&&Array.isArray(t.history)&&0!==t.history.length||(t={currentId:0,history:[{id:0,name:browser.i18n.getMessage("defaultChatName")||"00",records:[]}]},browser.storage.local.set({[s]:t}),r=0);var e=t.history.find(e=>e.id===r);e?(h.innerText="",(f=e.records?[...e.records]:[]).forEach((e,t)=>{var r="user"===e.role?e.content:marked.parse(e.content),a="user"===e.role?"self":"assistant";w(replaceThinkTags(r),e.model||a,e.rtime,!0,e.fileInfo)}),copyToClipboard(h),thinkCollapseExpanded(h),t.currentId!==r&&(t.currentId=r,browser.storage.local.set({[s]:t})),x(t.history,t.currentId),C(a)):(e=t.history.find(e=>0===e.id)||t.history[0])?E(a,e.id):h.innerText=browser.i18n.getMessage("chatHistoryCorrupted")||"聊天历史错误，请尝试清除会话或重启"})}function x(e,r){let a=document.getElementById("chat_records");a&&(a.innerHTML="",Array.isArray(e)&&0!==e.length?e.forEach(e=>{var t=document.createElement("a");t.className="btn btn-sm btn-outline-secondary me-1 mb-1 "+(e.id===r?"active":""),t.href="#",t.textContent=e.name,t.dataset.sessionId=e.id,t.addEventListener("click",e=>{c&&(e.preventDefault(),(e=parseInt(e.target.dataset.sessionId,10))!==r)&&E(d||"0",e)}),a.appendChild(t)}):((e=document.createElement("span")).className="text-muted small",e.textContent=browser.i18n.getMessage("noChatHistorySessions")||"暂无聊天会话",a.appendChild(e)))}function S(a){f.forEach(e=>{e.fileInfo&&(e.fileInfo.send=a)}),h.querySelectorAll(".message").forEach(e=>{let t=parseInt(e.dataset.timestamp,10);var r=f.find(e=>e.rtime===t);r&&r.fileInfo&&(r=e.querySelector(".activate-message-btn"))&&(r.textContent=a?"☑":"◻")})}function k(){let r="chatHistory_"+(d||"0");browser.storage.local.get(r,async e=>{let t=e[r];t&&Array.isArray(t.history)||(t={currentId:t?.currentId??0,history:[]}).history.some(e=>e.id===t.currentId)||(e=0===t.currentId?browser.i18n.getMessage("defaultChatName")||"00":"Session "+t.currentId,t.history.push({id:t.currentId,name:e,records:[]}));var e=t.history.findIndex(e=>e.id===t.currentId);-1!==e?t.history[e].records=[...f]:(e=0===t.currentId?browser.i18n.getMessage("defaultChatName")||"00":"Session "+t.currentId,t.history.push({id:t.currentId,name:e,records:[...f]}),x(t.history,t.currentId)),await browser.storage.local.set({[r]:t})})}function C(){let t=d||"0";var e;"0"!==t&&0<g.length&&(e=g.find(e=>String(e.id)===t))&&e.sample&&0===f.length&&I(browser.i18n.getMessage("inputSample")+" : "+e.sample,"sample-message")}async function $(t){return new Promise(e=>{e(window.confirm(t))})}h.addEventListener("scroll",function(){var{scrollTop:e,scrollHeight:t,clientHeight:r}=h,a=e,a=(a<n&&20<t-r-e&&(v=!0),n=a<=0?0:a,Math.abs(e+r-t)<5);a&&(v=!1)}),l.addEventListener("keydown",e=>{"Enter"===e.key&&(e.ctrlKey||e.shiftKey)||"Enter"===e.key&&(e.preventDefault(),y())}),t.addEventListener("click",e=>{e.preventDefault(),y()}),a.addEventListener("click",async e=>{e.preventDefault(),c=!0,m&&abortSession(m),b(!1)}),document.getElementById("b_image").addEventListener("click",e=>{e.preventDefault(),document.getElementById("imageUpload").click()}),document.getElementById("imageUpload").addEventListener("change",e=>{let a=e.target.files[0];a&&("application/pdf"===a.type||a.type.startsWith("video/")||a.type.startsWith("audio/")||a.type.startsWith("image/"))?((e=new FileReader).onload=e=>{var t={name:a.name,type:a.type,size:a.size,send:!0},e=e.target.result,r=Date.now();w(e,"self",r,!0,t),f.push({role:"user",content:e,rtime:r,fileInfo:t}),k()},e.readAsDataURL(a)):alert("Unsupported file format")}),s&&s.addEventListener("click",e=>{e.preventDefault(),s.classList.toggle("active-fish"),(async e=>{var t=DB_KEY.fishIconActive+"_"+(d||"0");await browser.storage.local.set({[t]:e}),u=!e})(s.classList.contains("active-fish"))}),r.addEventListener("change",e=>{e.preventDefault(),location.href="./chat.html?id="+e.target.value}),document.getElementById("b_clear").addEventListener("click",async e=>{if(c&&(e.preventDefault(),await $(browser.i18n.getMessage("confirmClearChat")))){let r=d||"0",a="chatHistory_"+r;browser.storage.local.get(a,async e=>{let t=e[a]||{currentId:0,history:[{id:0,name:browser.i18n.getMessage("defaultChatName")||"00",records:[]}]};e=t.history.findIndex(e=>e.id===t.currentId);-1!==e&&t.history.splice(e,1),0===t.history.length?(t.currentId=0,t.history.push({id:0,name:browser.i18n.getMessage("defaultChatName")||"00",records:[]})):t.currentId=t.history[t.history.length-1].id,await browser.storage.local.set({[a]:t}),h.innerText="",f=[],E(r,t.currentId),x(t.history,t.currentId)})}}),document.getElementById("b_new").addEventListener("click",async e=>{if(c&&(e.preventDefault(),0!==f.length)){let r=d||"0",a="chatHistory_"+r;browser.storage.local.get(a,async e=>{let t=e[a]||{currentId:0,history:[{id:0,name:browser.i18n.getMessage("defaultChatName")||"00",records:[]}]};e=t.history.findIndex(e=>e.id===t.currentId),-1!==e?t.history[e].records=[...f]:t.history.push({id:t.currentId,name:"Session "+t.currentId,records:[...f]}),e=0<t.history.length?Math.max(...t.history.map(e=>e.id))+1:1;t.history.push({id:e,name:(e<10?"0":"")+e,records:[]}),t.currentId=e,await browser.storage.local.set({[a]:t}),h.innerText="",f=[],x(t.history,t.currentId),C(r,t.currentId)})}}),i18n(),browser.storage.local.get(DB_KEY.apiConfig,function(e){o=e[DB_KEY.apiConfig]||{temperature:.7,top_p:.9,think:!1}});var e=document.getElementById("b_apiSettings"),M=`
    <div style="min-width: 250px;">
    <form id="api-settings-form-popover">
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label for="temperatureInputPopover" class="form-label mb-0">${browser.i18n.getMessage("apiSettingsCreativityLabel")}</label>
          <span class="badge bg-primary rounded-pill" id="temperatureValueDisplayPopover">1.0</span>
        </div>
        <input type="range" class="form-range" id="temperatureInputPopover" step="0.1" min="0" max="2">
        <div class="text-muted small mt-1">${browser.i18n.getMessage("apiSettingsCreativityDesc")}</div>
      </div>
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label for="topPInputPopover" class="form-label mb-0">${browser.i18n.getMessage("apiSettingsFocusLabel")}</label>
          <span class="badge bg-primary rounded-pill" id="topPValueDisplayPopover">1.0</span>
        </div>
        <input type="range" class="form-range" id="topPInputPopover" step="0.1" min="0" max="1">
        <div class="text-muted small mt-1">${browser.i18n.getMessage("apiSettingsFocusDesc")}</div>
      </div>
      <div class="mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="thinkModeTogglePopover">
          <label class="form-check-label" for="thinkModeTogglePopover">
            Think Mode
          </label>
        </div>
        <div class="text-muted small mt-1">Thinking models, Ollama version 0.9 or newer.</div>
      </div>
      <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-sm btn-secondary me-2" id="resetApiSettingsBtnPopover">${browser.i18n.getMessage("apiSettingsResetButton")}</button>
        <button type="button" class="btn btn-primary btn-sm" id="saveApiSettingsBtnPopover">${browser.i18n.getMessage("apiSettingsSaveButton")}</button>
      </div>
    </form>
    </div>    
    `;function P(){var e,t,r=document.querySelector(".popover-body");r&&(e=r.querySelector("#temperatureInputPopover"),t=r.querySelector("#topPInputPopover"),r=r.querySelector("#thinkModeTogglePopover"),e)&&t&&r&&(o={temperature:parseFloat(e.value),top_p:parseFloat(t.value),think:r.checked},browser.storage.local.set({[DB_KEY.apiConfig]:o}),i)&&i.hide()}async function A(){var e,t,r,a,s={temperature:.7,top_p:.9,think:!1},n=(o={...s},document.querySelector(".popover-body"));n&&(e=n.querySelector("#temperatureInputPopover"),t=n.querySelector("#temperatureValueDisplayPopover"),r=n.querySelector("#topPInputPopover"),a=n.querySelector("#topPValueDisplayPopover"),n=n.querySelector("#thinkModeTogglePopover"),e&&t&&(e.value=s.temperature,t.textContent=parseFloat(e.value).toFixed(1)),r&&a&&(r.value=s.top_p,a.textContent=parseFloat(r.value).toFixed(1)),n)&&(n.checked=s.think),browser.storage.local.set({[DB_KEY.apiConfig]:o})}e&&(i=new bootstrap.Popover(e,{content:M,html:!0,sanitize:!1,placement:"top",trigger:"click focus"}),e.addEventListener("shown.bs.popover",()=>{var s=document.querySelector(".popover-body");if(s){let e=s.querySelector("#temperatureInputPopover"),t=s.querySelector("#temperatureValueDisplayPopover"),r=s.querySelector("#topPInputPopover"),a=s.querySelector("#topPValueDisplayPopover");var n=s.querySelector("#thinkModeTogglePopover"),i=s.querySelector("#saveApiSettingsBtnPopover"),s=s.querySelector("#resetApiSettingsBtnPopover");e&&t&&(e.value=o.temperature,t.textContent=parseFloat(e.value).toFixed(1),e.addEventListener("input",()=>t.textContent=parseFloat(e.value).toFixed(1))),r&&a&&(r.value=o.top_p,a.textContent=parseFloat(r.value).toFixed(1),r.addEventListener("input",()=>a.textContent=parseFloat(r.value).toFixed(1))),n&&(n.checked=o.think),i&&i.addEventListener("click",P),s&&s.addEventListener("click",A)}}),document.body.addEventListener("click",function(e){var e=e.target,t=document.getElementById("b_apiSettings"),r=document.querySelector(".popover");!r||r.contains(e)||t.contains(e)||i&&i.hide()})),await new Promise(t=>{browser.storage.local.get(DB_KEY.chatTpaList,function(e){g=e[DB_KEY.chatTpaList]||[{id:1,name:browser.i18n.getMessage("directorExample1_name"),prompt:browser.i18n.getMessage("directorExample1_prompt"),sample:browser.i18n.getMessage("directorExample1_sample")}],!e[DB_KEY.chatTpaList]&&0<g.length&&browser.storage.local.set({[DB_KEY.chatTpaList]:g}),r.options.length=0,r.options.add(new Option(browser.i18n.getMessage("chatOnly"),"0")),g.forEach(e=>{var t=new Option(e.name,String(e.id));d&&String(e.id)===d&&(t.selected=!0),r.options.add(t)}),t()})});let B=d||"0",D="chatHistory_"+B,L=(browser.storage.local.get(D,async e=>{let t=e[D];t?.history&&Array.isArray(t.history)&&0!==t.history.length||(t={currentId:0,history:[{id:0,name:browser.i18n.getMessage("defaultChatName")||"00",records:[]}]},await browser.storage.local.set({[D]:t})),t.history.some(e=>e.id===t.currentId)||(t.currentId=t.history[0]?.id??0),E(B,t.currentId),x(t.history,t.currentId)}),document.getElementById("modelList")),_=document.getElementById("modelDropdown");L&&(L.textContent="");try{var T=await getRuntimeConfig(),q=(_&&(_.textContent=T.modelName),document.getElementById("modelServer"));q&&(q.textContent=T.service),p=T.modelName;var N=await getService(T.service,T.apiUrl,T.apiKey).getModels();L&&N.forEach(t=>{var e=document.createElement("li"),r=document.createElement("a");r.className="dropdown-item",r.href="#",r.textContent=t,r.addEventListener("click",e=>{e.preventDefault(),_&&(_.textContent=t),p=t}),e.appendChild(r),L.appendChild(e)})}catch(e){console.error("初始化模型列表失败:",e),_&&(_.textContent="Error");M=document.getElementById("modelServer");M&&(M.textContent="N/A")}e=document.getElementById("modelSelectDiv");e&&(e.style.display=""),(async()=>{let t=DB_KEY.fishIconActive+"_"+(d||"0");browser.storage.local.get(t,function(e){e=e[t]||!1;s&&(e?s.classList.add("active-fish"):s.classList.remove("active-fish")),u=!e})})()});